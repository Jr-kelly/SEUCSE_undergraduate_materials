# co第五章

## CPU的组成和工作流程

![image-20210103191118523](.\..\..\typora-user-images\image-20210103191118523.png)

### CPU功能和部件：

1. 指令控制；PC，IR，ID；
2. 操作控制；控制信号电路；
3. 时间控制；时序信号电路；
4. 数据加工；ALU、FPU、PSG、REGs；
5. 外部访问；总线逻辑电路，缓冲寄存器MARMDR，MMU；
6. 异常及中断处理；中断机构；

MMU属于存储系统；

### 寄存器组织

所有寄存器=用户可见寄存器+专用寄存器；

#### 用户可见寄存器：

1. 数据REG：长度机器字长；
2. 地址REG：长度逻辑地址 或 段内地址；
3. GPRs：机器字长=逻辑地址 或 段内地址；
4. PSR：存放PSW，PSW=ZFOFSFCF（结果状态标志）+IFTF（执行方式标志）；

#### 专用寄存器：

PC，IR，MARMDR，控制REG（系统模式REG，段REG）；

### CPU工作流程

**CPU基本功能**：循环地执行指令，检测和处理异常和中断；

指令执行过程：取指，分析，执行，生成下条指令地址；

CPU工作流程：指令周期+中断周期；

**CPU的工作原理**：CU循环地产生工作流程所需的操作控制信号，数据通路实现工作流程所需的操作；

指令执行过程表示：操作序列：伪代码的形式，M[(R1)]<-(R0)这样；

基本操作组成要求：

1. 源数据/结果放在时序逻辑部件中；
2. 功能不可再分；

基本操作类型：MEM读，MEM写，算逻运算（R<-(R)op(R)），REG间传送。

## 数据通路的组织

功能部件+互连结构；

互连：总线结构 专用/点点结构；

总线：入段锁存器，出端三态门；仅用于多周期CPU；

专用：入段MUX，出端无要求；可用于单周期CPU；

### μOP：微操作，原子操作，四种基本操作+PC增量、置位复位等

总线：in out什么的；

专用：寄存器写需要Rin，但是**out直接Rsel=i**就行了。

#### 存储器读写：

异步：

- 读：Read，WMFC
- 写：Write，WMFC

同步：性能较差

- 读：1. Read；2. MDR_inB（第m个CLK时，MDR<-M[(MAR)]）
- 写：Write

数据通路设计方法：指令系统分析，功能部件设计，部件互连设计

## 控制器的组成

指令部件（PCIR属于DP，ID不属于），控制单元CU，中断处理机构；

**功能**：循环有序产生工作流程所需μOP信号；

### 控制器类型：基于μOP控制信号的产生方法

|                       | 硬布线控制器                             | 微程序控制器                     |
| --------------------- | ---------------------------------------- | -------------------------------- |
| μOP控制信号的描述方法 | 有限状态机                               | 微程序                           |
| 时序信号的循环周期    | 指令周期＋中断周期                       | 一个微程序周期                   |
| μOP控制信号的产生方法 | 组合逻辑电路（与时序信号[当前状态]相关） | 微指令执行部件（与时序信号无关） |

两者关系：

1. 一条指令的μOPCmd序列=一个微程序；
2. 一条μOP的时延≈一个微指令周期，单位为CLK周期；

### 时序信号的形成

时序系统的组成：表示时间组成的各种时序信号序列，无间隙无重叠，一时刻的有效信号<=1个。

#### 时序系统的组织

时序信号类型：

- 机器周期：基本操作，取指访存之类的；一个指令周期有很多机器周期；
- 节拍：一个μOP；
- 工作脉冲：μOP内部脉冲；

信号的定时基于节拍脉冲CP（不是CLK）；

##### 早期计算机：三级时序，机器周期 节拍 工作脉冲；

（每一级）信号个数：按照最复杂情况， 指令周期>=机器周期个数+1（中断周期，可能很多个周期）；

信号循环周期：定长/变长，常为后者；

信号表示功能：操作时间/操作类型，常为后者；

##### 现代计算机：两级时序，节拍 工作脉冲

信号个数：按照最复杂情况设置，考虑中断周期；

信号循环周期：节拍变长，工作脉冲定长；

信号表示功能：操作类型；

#### 时序信号形成电路的组成，时序系统的实现

定时逻辑+定序逻辑；

环形信号发生器干什么用？产生**节拍**信号序列。

注意这里是**节拍**。一个节拍一个μOP。环形信号发生器产生m个输出，这m个引脚轮流产生节拍。

一个指令周期=x个机器周期，一个机器周期=m个节拍，一个节拍=k个工作脉冲；

环形信号发生器：移位REG/计数器+译码器；

#### μOP的定时方式，时序系统中定时逻辑的实现

##### 同步控制方式

只受统一的基准时钟信号控制，时钟周期为最长μOP所需周期；

CP=CLK；

控制简单，时间浪费大，适合CPU内部的μOP定时；

##### 异步控制方式，应答方式，握手方式

CP与应答信号同步，节拍周期T\_cp=T\_收到应答-T\_发出命令；

应答信号ACK（如mfc），CP=ACK_i；

控制复杂，时间浪费小，适合CPU外部的μOP定时（时延相差较大）；

##### 联合控制方式，半同步方式

μOP时序受基准时钟信号和联络信号的共同控制；

基础为同步控制方式，支持异步控制方式：T_cp=k·T_clk，同步时k=1，异步时k>1；

定时逻辑举例：WMFC

WMFC=0时，CP=CLK；WMFC=1时，CP=CLK·mfc；

$CP=(\overline{WMFC}+WMFC*mfc)*CLK$；

应用方法：用μOPCmd指明控制方式；

时间浪费小，控制简单，适合所有μOP定时；

#### μOP控制信号的形成（形成电路的组织）

输入：时序信号（机器周期节拍工作脉冲），指令的操作码及寻址方式字段（op）、程序状态（ZF等）、机器状态（所响应的中断/异常请求类型）；

问：输入机器周期干什么？有些μOP控制信号和机器周期（当前操作种类也有关）；

问：输入工作脉冲干什么？

输出：所有的μOP控制信号，即状态转换图中所有的μOPCmd；

内部逻辑：组合逻辑（硬布线，实质编码器），存储逻辑（微程序，实质微主机）

### 硬布线控制器设计

两级时序，现代计算机的时序都是两级时序；

#### 基于有限状态机模型，FSM

当前状态：所有的时序信号，用状态部件保存；

下一状态产生函数：每个时序信号入端的有效逻辑；

状态部件+时序信号入端有效逻辑 = **时序信号形成电路**；

输出信号产生函数：μOP控制信号形成电路；

#### 设计步骤

1. 形成状态转换图；
2. 组织时序系统；
3. 设计时序信号形成电路；
4. 设计μOP控制信号形成电路；
5. 整合成CU；

### 微程序控制器设计

思想：

1. 每条指令的执行过程（μOPCmd序列）都用微程序表示，所有微程序存放在控制存储器CS中；
2. CU自动逐条取出并执行微指令，有序产生μOP控制信号；

#### 微程序相关术语

微命令：部件的操作控制信号（相当于**一个μOPCmd**）；

微指令：用格式及编码表示，可同时执行的一组**微命令**，相当于一个步骤中同时生效的所有μOPCmd；

微程序：实现特定功能的**微指令**序列（一个**机器周期**的μOPCmd序列，实现一个基本功能，不是一个指令的μOPCmd序列）；

控制存储器：专用于存放微程序的ROM，按微地址访问；

微指令周期：从CS中取出并执行一个微指令的时间（相当于一个节拍）；

#### 微指令

格式：定长指令字，操作控制字段+顺序控制字段；

取指、中断等共用微程序，各指令的微程序；

一个微程序内，最后一条微指令是跳转型，其余为顺序型；

#### 微程序CU的组成和工作原理

一级时序：相当于工作脉冲；

信号循环周期：一个微指令周期（取指+执行，相当于一节拍）；

工作脉冲数：μOPCmd所需+1；

μOP控制信号形成电路：微指令部件（μAR，μID，μIR，微地址形成电路）+CS；

μAR是什么？微地址寄存器，相当于PC；

工作原理：循环的取出、执行微指令；

μAR和PC的初值（Const）加电时由硬件产生；

### 硬布线微程序对比

![image-20210106144933773](.\..\..\typora-user-images\image-20210106144933773.png)

|                     | 硬布线控制器                  | 微程序控制器                               |
| ------------------- | ----------------------------- | ------------------------------------------ |
| 内部逻辑            | 组合逻辑                      | 存储逻辑                                   |
| 时序                | 两级时序，节拍工作脉冲        | 一级时序，工作脉冲                         |
| 时序信号形成电路    | 状态部件+时序信号入端有效逻辑 | 和硬布线类似，μAR←下一地址                 |
| μOP控制信号形成电路 | 组合逻辑，输出信号产生函数    | 微指令部件（μARμIDμIR，微地址形成电路）+CS |

时序信号中，工作脉冲用于数据通路，节拍用于CU、、、、、、、、、、、、、、

工作脉冲会输出到数据通路中作为某些部件的时钟信号，比如两个工作脉冲时，寄存器在CP上升沿写入，MEM在CP下降沿写入；

## 异常及中断处理

事件：改变程序正常执行顺序的特殊情况；

处理方法：硬件响应，软件执行事件处理程序，软件返回（继续执行或终止执行）；

### 异常：CPU内部执行指令

- 故障Fault，可能修复的异常，缺页除零溢出，返回当前指令/下一指令（修复）或结束程序（没修复，偏向硬件ALU/ID/MMU）；随时处理；
- 陷阱Trap，预先安排的异常，单步断点，返回下一指令，**指令结束时处理**（应用需求）；不是异常都随时处理吗？
- 终止Abort，不可修复的异常，无效表（页表坏了，偏向管理机制），终止程序/关机（能/否定位到程序）；随时处理；

### 中断：CPU外部的请求或程序控制流改变

- 可屏蔽中断（Interrupt Request，INTR），可暂不处理，键盘打印机，当前或多个指令周期结束后处理，屏蔽IF=0，返回下条指令；
- 不可屏蔽中断（Non Maskable Interrput，NMI），需立即处理，校验错掉电，当前指令周期结束后处理，返回下条指令或终止程序；

### 异常及中断的处理过程

响应，处理，返回；

中断事件组织：INTR多个，NMI一个轮询；

处理时机：检测时机不同，检测到就响应；

#### 响应步骤：

1. 保存断点（PC）和程序状态（PSR、GPRs交给异常处理程序（软件））；
2. 关中断，IF=0；
3. 向量方式：得到最紧急/优先的事件；由硬件实现；
4. 向量方式：获取处理程序入口地址；查中断向量表（Interrupt Vector Table，IVT），首址+i*表项长度，硬件实现；
5. PC<-处理程序入口地址；非向量方式，所有事件共用一个处理程序，该程序完成3（轮询，查询顺序对应优先级）4（子程序入口地址）

返回：IRET，恢复PC和PSR，和RET的区别是是否恢复PSR；

#### 中断机构组成：

![image-20210106193622795](.\..\..\typora-user-images\image-20210106193622795.png)

## 指令流水线技术

段：专门工作阶段，每个段使用专门的部件，时长为拍；

### 性能指标

- n条指令，m段；T串行=nmΔt，T流水=(n+m-1)Δt；
- 吞吐率Throughput=n/T流水=1/(n+m-1)Δt；
- 加速比Speedup=T串行/T流水=nm/(n+m-1)；加速比大于1；
- 效率Efficiency**（平均部件利用率）= 部件平均使用时间/整个运行时间**=n/(n+m-1)

### 组成要求

1. 流水线各个段操作相互独立；段间寄存器，时序部件；
2. 各个段操作同步；设置统一的拍时钟；
3. 各个段操作无冲突；结构冒险，控制冒险，数据冒险；

## 做ppt和书上的例题之后的感想（含考试题型！）

1. 变态简答，没什么办法；总结如下：
   - 指令执行过程包含 取指，译码，执行，生成下条指令地址的步骤；
   - CPU基本操作：指令控制，操作控制，时间控制，数据加工，外部访问，异常和中断处理；
   - CPU基本功能：循环地执行指令，检测和处理异常和中断；
   - CPU工作原理：DP实现指令执行过程的操作，CU产生DP所需的操作控制信号；
   - 单周期CPU时钟周期为最复杂指令的时延，要求部件不能复用；
   - 多周期CPU时钟周期为基本μOP所需时间，性能好，部件利用率高，成本低；
   - 控制器工作原理：循环有序产生CPU工作流程所需μOP控制信号；
   - 现代计算机两级时序系统：节拍，工作脉冲；时序信号个数按照最复杂的情况设置：机器周期信号个数为最复杂指令的机器周期数+1（中断周期），节拍信号个数为最复杂机器周期的μOP个数，工作脉冲应满足各个μOP的需求；
   - 一个节拍信号长度=主时钟信号周期；
   - 联合控制方式中同步异步的转换：设置应答信号，用μOPCmd指明控制方式，延长节拍；
   - 硬布线控制器基本思想：有限状态机；
   - 微程序控制器基本思想：每条指令的执行过程（μOPCmd序列）都用微程序表示，所有微程序存放在控制存储器CS中；CU自动逐条取出并执行微指令，有序产生μOP控制信号；
   - 微程序 μOP控制信号形成电路：微指令部件（μAR，μID，μIR，微地址形成电路）+CS；
2. 给出数据通路、指令格式和指令功能，写μOP和μOPCmd。注意：
   - **PC+1**！
   - **End**！取指时不要End，指令结束时End；
   - RD<-Imme时，Imme是指令内容，指令内容在内存里，所以要RD<-M[(PC)],PC+1；
   - 异步读写内存时都是Read，WMFC；Write，WMFC；
   - 专用结构：一个sel一个in；





