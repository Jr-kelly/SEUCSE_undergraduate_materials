# ca第五章 存储系统

ppt第10页思考题1。

LRU比较对法：课本202，参考书139。







8判断（说明理由）+2计算。

不要抄书，抄书会到坑里去。





cache性能优化
$$
T_A=T_{命中}+F*T_{缺失}
$$
减少缺失率F

增加cache块大小：

会影响什么？





什么算错了扣2分，算对了得6分，最后一个是什么东西？



串行->并行；提前提交任务。隐藏时延。

两级cache不太确定。



CPU内部的传送和计算。



为什么容量小会T取目录项下降？



机器字长：GPR、ALU宽度；

指令字长：IR宽度，和机器字长没关系。

存储字长：MEM芯片数据引脚宽度；

存储单元长度：一个地址对应多少位数，是CA中抽象的定义。

如SRAM0和SRAM1每个【存储字长】都是4为，存储单元长度是8位。



若缺页后调入页面把【在TLB里的页面】换掉了，怎么办？能保证一定不换掉吗？添加一位来标识？











## 虚拟存储器

### 组织

#### 原理

VM是面向程序的存储器模型。

![image-20210524173832672](.\..\..\typora-user-images\image-20210524173832672.png)

虚存-主存的交换单位：程序段/页；

存储管理方式：段式/页式/段页式；

层次管理：

- 映射方式：全相联映射，映射表（段/页表）在主存中，虚地址索引查一次；
- 地址变换：段首址+段内偏移，页基址#页内偏移。
- 替换算法：伪LRU（LRU位数=1玄学维护），写策略：写回法。

表长：不一定是S虚存/S交换（段/页），可能是程序实际页数。映射表描述信息：基址+表长。

##### 虚存-辅存

辅存分为交换区和文件物理空间，交换区为层次结构最靠外一级，文件物理空间是文件逻辑空间的物理载体。程序逻辑空间->文件逻辑空间->文件物理空间。

文件物理空间与逻辑空间的mapping：文件分配表(FAT)管理所有文件，每个文件占一个目录项；文件内容、设备空间按物理块(如扇区)进行管理，内容索引表实现文件内容到设备的映射管理。目录项中包含文件名称、类型、存取权限、内容索引表(占≥1个物理块)第1个物理块的设备地址(磁盘地址)、创建时间等。

#### 实现

MMU地址变换，os其他（缺页异常处理程序）。

缺页：执行异常处理程序+返回缺页的指令（从头执行，而不是从缺页的段如OF执行）。

#### 性能优化

- TVA＝TV命中＋F·TV缺失
- TV缺失＝T请求排队＋T事件响应＋T处理
- TV命中＝[T表项地址计算＋T访存(表项)＋T变换]＋T访存(数据) 

降低F：增加主存容量，增加页大小，两种页大小（对吞吐率大的数据（如视频）用非常大的页面），预取页式调度。

减少TV缺失：缺失作为异常事件（其实是中断，CPU外的事件），增设缺页向量寄存器（CPU里，存放缺页处理程序入口地址，IVT在主存中，省一次访存）。

减少TV命中：TLB（CPU中的小容量Cache，几十行、无需写策略，H≈99.99%）。

TLB：并行查快表/慢表，TLB缺失用硬件处理。

多种页大小：正常页：一级页表，二级页表，PTE；超大页：一级页表，直接取页。用标志位PSE区分。

超大页的offset=二级页表索引#正常页offset。

#### 示例：core i7的VM

VA 48b，PA 52b，页式管理（支持段页式），VP 4KB或4MB。

4级页表，页表项8B，log2(4KB/8B)=9，(48-12)/9=4。

页大小为4MB时，48=22+9+9+8，3级页表，最后一级索引只有8位。

页表项内容：1-3、4级略有不同，见ppy页57。

TLB组织：2级哈佛结构，都是4w组相联，TLB项有PID段（SMT同时多线程/超线程）。

地址变换过程：访问L1-TLB，访问L2-TLB 同时计算PTE地址，访问页表创建TLB行，缺页异常。

PT的base/limit放在CPU的控制寄存器/MMU里，反正是系统reg。

### 保护

策略：地址空间分共享区域/私有区域，其他进程禁止访问私有区域，授权访问共享区域。

保护的种类：区域保护（能不能访问），访问保护（只读/能写/能执行）。

#### 区域保护

##### 映像表保护

映像表就是页表/段表。空间保护，禁止即看不见。

私有区域：进程私有映像表；共享区域：系统公共映像表。

映像表项中含有保护属性。

![image-20210524192241368](.\..\..\typora-user-images\image-20210524192241368.png)

段号#段内偏移，一个16进制位是4个二进制位。

支持：段的base/limit，放在MMUreg。

##### 环状保护

级别环号，内层＞外层：应用程序＜os＜虚拟机管理程序＜安全管理程序。

外层只能通过syscall访问共享的内层空间。

每个进程拥有访问环号；映像表项中含有该区域保护环号；访问VM时，MMU比较访问环号与保护环号。

还有键式保护，是点点保护。

#### 访问保护

类型：读R、写W、执行E。

映像表项中含有该区域操作的允许类型；访问VM时，MMU比较访问类型和允许类型。

#### 常见方案

同时采用区域保护（映像表/环状）及访问保护；映像表项中含有多种保护信息）边界/环号/操作类型等）；MMU地址变换时全部保护。

保护模式：采用虚拟存储器、提供信息保护机制的CPU操作模式！

任国林很燃地加了感叹号，并不知道为什么。

#### 示例：Pentium

![image-20210524193132026](.\..\..\typora-user-images\image-20210524193132026.png)

GDT是最全局的，里面有TSS和LDT；

LDT是段表；

TSS有页表基址、段寄存器选择符、GPRS等，还有任务链表指针，指向这个任务。

啊，还是不太懂……

![image-20210524194225935](.\..\..\typora-user-images\image-20210524194225935.png)

GDTR是GDT的base/limit，TR是GDT的选择符+TSS的base/limit，LDTR是GDT的选择符+LDT的base/limit，CR3是page directory页目录的base/limit。不明白……

VM管理方式：段式/段页式。

![image-20210524194650877](.\..\..\typora-user-images\image-20210524194650877.png)

VM保护方式：

- 映像表保护：进程只能访问GDT和自身LDT；TI限定请求只能访问GDT及自身LDT。判断请求的VA≤LDTR/GDTR、段描述符的界限。
- 环状保护：4级，只用了0和3；判断请求的RPL≤目标段的DPL（保护环号，0最高）。
- 访问保护：数据段仅读写，代码段仅执行；判断请求的类型∈目标段的允许类型。

#### 示例：core i7

3级cache，L1级分D\$和I\$、4w组相联；L2 8w组相联；L3 核共享（i7有4个核）16w组相联。2级TLB，L1级分DTLB和ITLB。所有TLB都是4路组相联。

工作过程：地址变换+数据访问。拿到一个VA->变成PA（TLB）->按PA访存（cache）。

![image-20210527160642124](.\..\..\typora-user-images\image-20210527160642124.png)

会不会发生TLB缺失、cache命中的情况？会，可以TLB缺失页在主存里，cache可以命中。

会不会发生TLB命中、缺页的情况？不会，根据一致性，TLB若命中则页肯定在主存里。

一致性：若某一页被换出主存，TLB对应项V->0，cache清空该页内容。



思考题：

1、层次结构存储系统的产生原因是什么？为什么只有两个存储层次？不同层间信息交换单位大小为何不相同？

层次结构产生原因：容量、速度、价格间的矛盾。

只有两个存储层次：Cache-主存解决速度-价格矛盾，主存-辅存解决容量-价格矛盾。

层间信息交换单位：希望各个层次的平均访问时延大体相等，消除瓶颈。即缺失率*【平均传输一个字的时间】大体相等，采用突发传送方式，一次传【层间信息交换单位】个字。

2、如何实现组相联按地址并行查找？写一次法写策略的特征是什么？

组相联按地址并行查找：通过索引定位到组，同时对每一组内的每一个块进行tag比较，【组定位】和【组内块比较tag】的结果相乘，并作为三态门的控制信号决定是否读出该块内容。

写一次法写策略的特征：

修改一个cache中的块后，抛弃其他的cache中的该块。

4、虚存与Cache的实现技术有何异同？虚存访问的全过程有哪些环节？

虚存Cache实现技术异同：

主存-虚存：层次管理软件（os），地址变换硬件（MMU）。Cache-主存：均硬件。虚存保护：对页进行保护，保护信息在MMU中。

虚存访问全过程：虚存-主存地址变换失败（缺页），虚存-辅存地址变换，调页[页替换]，再次进行虚存-主存地址变换访问主存。

6、相对于用硬件处理TLB缺失，TLB缺失用软件处理时的性能差别有哪些？

更慢、不能隐藏【表项地址计算】的时延、成本更高。

7、优化VM性能的方法有哪些？虚存保护的种类、原理是什么？

降低F：增加主存容量，增加页大小，预取页，两种页大小（）。

减少T\_V缺失：缺失作为异常事件（其实是中断，CPU外，减少T\_请求排队），增设缺页向量寄存器（IVT在主存中，寄存器在CPU里，存放缺页处理程序入口地址，省一次访存，减少T\_事件响应）。

减少T\_V命中：增设TLB（页表缓冲器，几十行，无需写策略，在CPU中，省一次查页表访存）

8、Pentium如何实现虚存保护的？

映像表保护：只能访问GDT和自身LDT，判断访问地址是否越界。

换装保护：判断请求的RPL是否≤目标短的DPL（0最高）。

访问保护：判断请求类型∈目标段允许类型。













