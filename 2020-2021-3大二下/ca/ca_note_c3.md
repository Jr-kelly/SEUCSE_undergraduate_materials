# ca第三章 流水线

## 流水线的概念

CISC: IF->ID->OF(取数)->EX->WB;

RISC: IF->ID(此时取数)->EX->MEM->WB;

工作原理：每条指令按序通过各段，不同指令的执行过程重叠。

独立同步无冲突：

- 各段操作相互独立：源数据来自时序部件，结果存到时序部件：段间寄存器。
- 各段操作同步：设置公共时钟，拍时钟周期=max{段时长}。
- 各段操作无冲突：增设部件/控制器，解决结构/数据/控制冒险。

### 分类

处理级别：操作级（浮点加法）、指令级（我们学的）、处理机级（宏流水）。

功能：单功能、多功能；

工作方式：静态（换功能之前要排空）、动态（不用排空）。此时已经是多功能。

结构：线性、非线性（复用部件/反馈回路，加了转发线路是不是就非线性了）；

流入/流出次序：顺序乱序；

感觉加了转发线路就非线性了，ppt上的图就是一个转发线路。

### 性能指标

吞吐率TP。瓶颈段；

加速比S；

效率E：部件利用率，任务所占时空区/整个时空区（大矩形）。

优化效率的方法：增加任务数量n。

### 流水线段数选择

基于额外开销：段间寄存器延迟、时钟偏移。Δt-(d+t3)=T/m（m是段数）。

基于性/价：性能指吞吐率TP=1/(d+(T/m))，价=a（原价）+bm（段间reg），m=sqrt(aT/db)。

## 流水线的冒险处理

### 经典的RISC流水线

IF：访存取指；

ID：指令译码，读寄存器取操作数。

EX：ALU指令进行计算；ls指令算出有效地址；分支指令得到是否转移；

MEM：ls指令访存；分支指令写PC。

WB：ALU指令和load指令写回。

### 相关

数据相关：真数据相关（读到了旧值，应该读新值）。

名相关：反相关（读到了被提前写乱的值）/输出相关（写的顺序反了）。换名。

控制相关。

冒险：因相关等原因，流水异常。

### 结构冒险

结构要求：每个部件只能使用一次，使用时间在流水中固定。

重复设置部件，分时使用部件。

增设缓冲器，存储、指令预取。哈佛结构。

### 数据冒险

先写后读，read after write。

check后面指令的源操作数是不是这个指令的目的操作数。

阻塞（硬），转发（硬），乱序执行（软）。

#### 阻塞法

插入气泡！nop，如\$0<-\$2 | $3；

ID检测RAW。

暂停IF段：不写PC，不写IF/ID段间reg。

ID立刻产生气泡：把nop指令写到ID/EX段间reg。

![image-20210411155827651](.\..\..\typora-user-images\image-20210411155827651.png)

停顿拍数：若WB可以前半拍写后半拍读，则2。若不可以则3。

#### 转发法

冲突指令，在马上要使用数据时，从数据产生段获取数据。

增设转发线路，MUX。

停顿：能转发时0。

load-use冒险：存疑。

若不转发、WB后半拍写，停3拍。

若不转发、WB前半拍写，停2拍。

若MEM-EX转发，停1拍。

#### 乱序执行法

让后续无RAW的指令先执行，通过软件进行调度。

若ok，则不停顿。

结果：出现先读后写WAR和先写后写RAR冒险。

### 控制冒险

阻塞（硬）、分支预测（硬）、延迟分支（软）。

#### 阻塞法

一旦ID段检测到控制冒险，则暂停IF段，ID下拍起产生气泡。

MEM段写新PC。停3拍。

![image-20210411165327729](.\..\..\typora-user-images\image-20210411165327729.png)

性能优化：

尽早判断是否转移。如ID段取回源操作数就接着比较。

尽早计算转移目标地址。如ID段增设加法器，马上算。

#### 分支预测法

预测转移方向，猜对就继续，猜错还要比阻塞多停一拍（那一拍全是bub），4拍。

注意啊，bne只有4拍的，没有WB。所以排空那一拍其实能占据bne的WB。

ID预测：猜对停1拍。是ID才【算出目标地址+得到预测的是否转移】？

IF预测：猜对停0拍。（未指明什么时候预测就按IF预测）

猜对就不要写PC了……早就执行到后面了，不用再写回去。

静态预测动态预测。

#### 延迟分支法

延迟槽中指令总是被执行。

阻塞时延迟槽中全是nop。

编译时重排序指令序列。

延迟槽大小=1，此时性能可以接受。

（为什么延迟槽大小可以=1？）

与分支预测法不兼容。

## 流水线的实现

### 数据冒险

检测：(rs或rt＝ID/EX.rtd)|(rs或rt＝EX/MEM.rtd) ；

这就是转发线路的控制信号。

![image-20210411171823525](.\..\..\typora-user-images\image-20210411171823525.png)

### 控制冒险

检测：op＝beq或bne或j ；

![image-20210411171841821](.\..\..\typora-user-images\image-20210411171841821.png)

如何实现【IF立刻停顿3拍】？

(OP=beq|ID/EX.PCWrB|EX/MEM.PCWrB)=1时暂停IF段，ID/EX.PCWrB|EX/MEM.PCWrB|MEM/WB.PCWrB)=1产生气泡。

大意就是检测段间reg的状态。

将比较器移到ID段，可以提高性能吗？实现方法？

可以；指令不转移时（ID段），IF段不停顿（取的是下条指令）；指令转移时，同阻塞法。原图中，指令不转移时（EX段 ），IF段停顿1拍（不写IF/ID、但写PC），ID停顿1拍（产生气泡）。

## 例题

### 判断

给出段间reg状态，判断是否有RAW，落实到电路上。

控制冒险落实到电路上的处理。

### 分析流水线性能

![image-20210411121206720](.\..\..\typora-user-images\image-20210411121206720.png)

要考虑数据冒险。

不过甚至可能会给出转发线路，只有EX没有MEM，数据冒险一半考虑一半直接转发，然后load-store冒险要推延一拍……诸如此类。

### RAW和控制冒险

哪些指令之间存在RAW？写时冲突指令在前，I2-I1这样。

采用阻塞法处理时执行时间？时空图？TP、S、E？

采用转发法（两种转发线路）？时空图、TP、S、E？







 











