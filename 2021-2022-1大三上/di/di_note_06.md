# di 06 图像压缩

原理：减小数据冗余（data redundancy）。

三类冗余：

- 编码冗余：有效灰度级是12位，但每个像素占16位；每个灰度值出现频率不同，可以变长编码。【可以完全恢复，不失真】
- 像素间相关性冗余：邻近像素值相近，把每一个像素值都记一遍就有些冗余，可以只记录残差。【可以完全恢复，不失真】
  - 行程编码；
  - 预测编码；
  - 变换域表达（PCA、COSINE、WAVELET）。
- 视觉冗余：依照视觉心理学，丢掉观众不感兴趣的信息。【有损处理】

评价指标：压缩比。$C_R=n_{img}/n_{cod}$，$n_{img}$ 图像数据量，$n_{cod}$ 编码后数据量，压缩比＞1。

压缩误差评估：（有损）

- 均方误差（rms）：
  $$
  e_{rms}=\bigg[\frac 1{MN}\sum_{x=0}^{M-1}\sum_{y=0}^{N-1}
  [\hat f(x,y)-f(x,y)]^2\bigg]^{1/2}
  $$

- 信噪比：（考虑原来图像的信号能量，比rms更好，设A原200现195、B原10现5，rms相同，但SNR上B更糟糕）
  $$
  SNR=\frac{\sum\sum[\hat f(x,y)]^2}{[\hat f(x,y)-f(x,y)]^2}
  $$

两个有损压缩算法的比较：固定压缩比$C_R$，比谁的信噪比SNR高；固定信噪比SNR，比谁的压缩比$C_R$高。无损压缩算法：压缩比越高越好。

## 编码

香农第一定理（Shannon's 1st theorem）：

编码最小平均字长，熵（entropy）：$H=-\sum_r p(r)\log_2p(r)$。

### 熵编码，Huffman coding

建树+标注子树的01。两个code之间不需要分隔符。

缺点：对bit错误很敏感，一个bit错误/丢失可能造成全局错误。

#### 移位Huffman编码

缩短huffman编码的区间。如果出现编码区间以外的像素，首先平移到区间内（加一个表示平移信息的前缀），然后进行编码。

### 算术编码，arithmetic coding

时间不够跳过去。

### 行程编码，run-length coding

很简单的思想，用【我的值，我身后紧跟了多少和我一样的值】的格式来记录。

比如 555 33 4 3 22222，可以记录为【(5,3) (3,2) (4,1) (3,1) (2,5)】→【5, 3, 3, 2, 4, 1, 3, 1, 2, 5】，是无损编码。

适用于多个连续相同像素值。极端情况下，完全没有连续的相同像素值，这时每一个像素值后面都跟一个1，反而效率低。

GIF使用了行程编码。

改进：LZW是行程编码的扩展。比如，对 1 7 1 7 1 7 这样的像素，把 1 7 看作一个单元，记录在元素查找表，就可以记录成 (地址(1,7) , 3)。

二维行程编码就不多说了。

## JPEG图像压缩标准

 JPEG： Joint Photographic Experts Group。

JPEG有无损压缩的版本（JPEG Lossless），只不过应用很少，因此一般认为JPEG是有损压缩标准（JPEG Lossy）。JPEG 2000 兼容了无损和有损，很好但是不火。

![image-20211127180442325](.\..\..\typora-user-images\image-20211127180442325.png)

以下内容侧重压缩过程。

### preprocess

颜色空间变换：

- 亮度Y，色差Cb Cr，由RGB经过线性变换得到。接下来就认为是3个独立的图像了。
- 灰度图像处理思路，Y直接赋值为灰度，认为CbCr不存在（尺寸=0）。
- 是可逆的线性变换，但是减小直方图上的细节丰富程度，对YCbCr降采样之后再变换回来，几乎看不出区别。

降采样：

- 目前广泛采用的方案：Y保持原来分辨率，CbCr 4个里面取一个，加起来是原来0.5倍的数据量。
- 有可能引起信息损失，但不是一定，因为降采样不是必须的。【判断题】预处理可能引起信息损失，但不是一定，是对的。

分块：

- 把整个图像分成小块，8\*8广泛采用，每一个小块称为一个MCU（minimum coded unit）。也有16\*16的小块，但基本没有应用。

### DCT变换

作用于固定大小的MCU。

![image-20211229222819755](.\..\..\typora-user-images\image-20211229222819755.png)

为什么是DCT（离散余弦变换，discrete consine transform）：

- 傅里叶变换的系数是复数，包含实部虚部（两倍的存储量），而DCT变换结果是实数。
- 傅里叶变换的周期性延拓，认为 n-1 和 0 是相邻的像素（其实是 n-1 和下一个块的 0 相邻），因此会干扰。而DCT的周期性延拓是翻书一样的延拓，123 → 123321。
- 可以预先把系数算好，到时候直接卷积。

### cosine 频域的系统量化

$F_q(u,v) = F(u,v)/Q_{uv}$，Quv是Quantization Matrix。

量化矩阵是约定出来的（调查问卷，用这个值变换，后你觉得图像有变化吗？），不是算出来的。

量化矩阵要先进一个scale factor，scale factor的值由品质因子Q决定，Q可以控制失真率，Q值越大品质越好。

### 编码

直流分量DC（每个小块的左上角矩阵元素）：difference coding。

交流分量AC：RLE，huffman encoding。

#### DC

差分预测编码：记录 DC_0 原本的值，接下来的数值用差分形式记录，(size(4bit), diff) 的二元组，size 表示 diff 的位数，最多15位。

接下来再次进行编码，编码表（不同 size 对应什么编码）已经给出，根据统计数据的 huffman tree 生成，因此亮度和色差的编码不同。

#### AC

zig-zag 行程编码。格式：(count of 0, size(4bit), diff value)。count of 0 表示该像素后面跟了多少个0。

越是高频部分值越小，可能出现最后一小半图像全是0的情况，此时也不记录有多少个0了，直接编码结束。

接下来再次进行编码，编码表已经给出（不同 cnt of 0+size 对应什么编码），根据统计数据的 huffman tree 生成，因此亮度和色差的编码不同。

DC和AC的编码表是可以自定义的，因此也会被记录在JPEG文件里。

### JPEG文件结构

分段，引导词+段内容。

### 500字描述压缩过程

- 预处理：
  - 颜色空间变换：用一个线性变换，将 RGB 转换为 Y Cb Cr（亮度+色差）。
  - 降采样：亮度维持原分辨率，两个色差通道进行 4*4 的降采样【失真】【通过降采样大小调节压缩比】，将3个通道的数据作为各自独立的单通道图像对待。
  - 分块：将图像整齐切割成 8*8 的小块。
- DCT变换：
  - 对每一个小块，进行离散余弦变换。
- 量化：
  - 通过品质因子调整量化矩阵【调节压缩比】，对每个小块应用量化矩阵（小块对应位置值 / 矩阵对应位置值）【失真】，每个通道的量化矩阵不同。
- 直流分量（DC）编码：
  - 差分预测编码：用差分的思想记录数值，每条记录的格式为 (size(4bit), diff) 二元组，size 表示 diff（该数值与前一数值的差）的位数。
  - 类似 huffman 的编码：对每条记录进行编码，编码表（将 size 进行编码）根据统计数据中不同 size 出现频率、用 huffman tree 生成。
- 交流分量（AC）编码：
  - zig-zag 行程编码：将每个小块剩下 63 个数据按 zig-zag 顺序编排后进行行程编码，每条记录的格式为 (cnt of 0(4bit), size(4bit), diff value) 三元组，cnt of 0 表示该数值后面紧跟0的个数，(size(4bit), diff value) 表示第一个非0像素与该数值的差分。
  - 类似 huffman 的编码：对每条记录进行编码，编码表（将 (cnt of 0, size) 进行编码）同样根据统计数据生成。

### 200字描述压缩过程

- 预处理：
  - 颜色空间变换：线性变换，RGB → Y Cb Cr。
  - 降采样。
  - 分块：将图像切割成 8*8 的小块。
- DCT变换：对每个小块进行离散余弦变换。
- 量化：通过品质因子调整量化矩阵，对每个小块应用量化矩阵。
- 直流分量（DC）编码：
  - 差分预测编码+huffman：记录格式为 (size(4bit), diff) 二元组，然后对每条记录应用类似 huffman 的编码。
- 交流分量（AC）编码：
  - zig-zag 行程编码+huffman：将数据按zig-zag顺序编排后进行行程编码，记录格式为 (cnt of 0(4bit), size(4bit), diff value) 三元组，然后应用类似 huffman 的编码。

调节压缩比/失真率：

- 降采样：一般来说，亮度维持原分辨率，两个色差通道进行 4*4 的降采样，但色差通道的降采样大小可以调整。
- 量化：品质因子越大，失真率越小。

## 一个Huffman编码的例题

![image-20211225161645787](.\..\..\typora-user-images\image-20211225161645787.png)







