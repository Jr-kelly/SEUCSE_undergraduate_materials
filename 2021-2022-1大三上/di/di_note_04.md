# di 04 图像增强

总目标：提高图像质量（视觉感受）。

使用时机：用来增强给人看，而不是给机器进一步处理（如目标检测、文本识别）。

思路：分析图像质量不好的原因，对症下药。

章节要求：分析图像特征，掌握算法构思/动机，根据图像特性设计组合算法。

图像质量差的原因：

- 原因1：灰度分布不合理。
  - 具体体现：
    - 曝光不足，图像过暗，没有充分利用高灰度区间；
    - 曝光过度，图像过亮，没有充分利用低灰度区间；
    - 逆光，图像明暗对比过大，只利用了少量的灰度。
  - 目标：灰度映射，充分使用灰度动态范围，不浪费灰度区间。
- 原因2：噪声。
  - 目标：抑制噪声，提高信噪比。
- 原因3：模糊。
  - 目标：增强细节，提高对比度。

## 灰度映射（灰度直方图变换）

### 灰度直方图，gray histogram

$h(r_k)=\underset{(x,y)}{card}\{I(x,y)=r_k\}$，灰度等于$r_k$的像素总数，$r_k\in[0,K-1]$。

以$r_k$为横轴，$h(r_k)$为纵轴，画出曲线，就是灰度直方图。

$\sum_k h(r_k)=n$，即图像面积。

用图像面积对直方图进行归一化，得到归一化直方图（normalized histogram）：$p(r_k)=h(r_k)/n$。$0\le p(r_k)\le1$，$\sum_k p(r_k)=1$，和概率密度相似。

灰度直方图的峰：灰度聚类，大量像素具有相近的灰度值。

直方图没有包含图像的结构信息。

### 灰度映射，gray mapping

最大限度均匀覆盖灰度范围。

增加覆盖灰度范围，提高分布的均匀性，可以牺牲有效灰度级。

$s=T(r)$，r是原始图像灰度，s是目标图像灰度。

灰度映射函数是单调函数。

#### 分段线性映射

![image-20211011120106230](.\..\..\typora-user-images\image-20211011120106230.png)

#### gamma矫正，gamma correction

$s=r^{\gamma}$。

看导数：导数＞1就是灰度范围拉伸。

$s'=\gamma r^{\gamma-1}$。γ=1时，恒等函数；γ＜1时，低灰度范围拉伸，高灰度范围压缩；γ＞1，低灰度范围压缩，高灰度范围拉伸。

![image-20211025111144746](.\..\..\typora-user-images\image-20211025111144746.png)

处理之前要先归一化，[0,256) -> [0,1)，最后再调整到[0,256)。

#### 灰度窗调整

当【图像灰度动态范围】远大于【显示设备的动态范围】时，直接进行显示，灰度范围会浪费。

灰度窗调整（窗宽窗位调整）：图像灰度范围的某一段（灰度窗）【线性映射到】显示设备的灰度范围。灰度窗的位置和长度都可以变化。

本质上是分段线性映射。

### 直方图均衡算法

适合解决曝光问题（不足/过度），但是减少有效灰度级（相邻的像素较少的灰度级被合并），导致细节丢失。

凡是造成信息丢失的步骤，一定要放在信息处理的最后。

#### 累计灰度直方图，cumulative gray histogram

$$
H(k)=\sum_{i=1}^k p(i),k=[1,K]
\\
H(k)=
\left\{\begin{array}{}
p(1) & (k=1) \\
H(k-1)+p(k) & otherwise
\end{array}{}\right.
$$

单调增加，最后=1。

绝对均匀的灰度直方图 → 通过原点直线的累计直方图。

（上面的话中，灰度是连续的，但数字图像的灰度是离散的。为使累计直方图通过原点，需要平移灰度级，如从01234平移到12345。不然做累加时，累计直方图与y轴相交于第0个灰度级的直方图值。）

#### 直方图均衡算法原理

- 我们算出原始图像的累计直方图 H(r)，将它与【通过原点直线】H(s) 放在一起。原灰度级为 r，希望得到灰度映射 s=s(r)。
- 做与横轴（灰度）平行、截纵轴于 H(s) 的直线，截两个累计直方图，两个截点的横坐标分别为 r 和 s 。为了使映射后的累计直方图像直线（灰度直方图均匀），r 的映射值 s应该满足 H(r)=H(s) 。
- 如果对灰度进行归一化（将范围线性映射到01之间），因为累计直方图的范围也是01之间，所以【通过原点直线】是45°的，有 H(s)=s 。所以，s=H(r) 即为所求映射。
- 总结：直接将 灰度级对应的 累计直方图的值 作为 灰度级的映射结果。
- 细节：映射后的累计直方图曲线不是标准的直线、有台阶，因为灰度级是数字的、不是连续的。如果灰度级连续，会得到标准直线。

理论步骤：向右平移一个单位（避免从0开始）→ 归一化 → 直方图均衡 → 归一化逆变换 → 向左平移一个单位（重新从0开始）→ 四舍五入到离散的灰度级（损失信息）。

实际情况：根本不平移，因为灰度级很多，从0开始造成的偏移很小，无所谓。

#### 例题

![image-20211225161217937](.\..\..\typora-user-images\image-20211225161217937.png)

![image-20211225161247891](.\..\..\typora-user-images\image-20211225161247891.png)

## 图像平滑（噪声抑制），denoising

总体思路：

- 空间域：
  - 线性方法（线性滤波器）：均值滤波器、高斯滤波器、维纳滤波器……
  - 非线性方法：中值滤波器、全变分、非局部均值、双边滤波……
  - 结合线性与非线性的方法。
  - 线性方法和非线性方法都用在灰度图像上，不能用在二值图像。
- 形态学的方法（二值图像）。
- 基于模糊理论的方法（上世纪90年代，小众，意大利学者）。
- 变换域方法：小波变换/小波域，主成分分析（PCA）。可以被ANN方法覆盖。

### 图像平均，image averaging

#### 时间上的平均

原始图像（无噪声的理想图像）：I。

采样图像（包含噪声）：$I(t), (t=1, …, N)$。

噪声跟时间有关系，不同时刻的噪声不一样。

$I(t)=I+n(t)$，n(t)服从高斯分布（正态分布）。

$\hat{I}=\frac1N\sum_{t=1}^NI(t)=I+\frac1N\sum_{t=1}^Nn(t)$，σ²（方差）会变成原来的1/N。

（图像平均，是延长曝光时间的原理。）

#### 邻域像素的平均

$$
\hat{I}(x,y)=\frac{1}{(2W+1)^2}\sum_{i=-W}^W\sum_{j=-W}^WI(x+i,y+j)
$$

加权平均（卷积）：
$$
\hat{I}(x,y)=\sum_{i=-W}^W\sum_{j=-W}^Wh(i,j)I(x-i,y-j)
$$
不满足 I 为常数的约束（不同于时间上的平均），【平均后像素值的期望】不再与【理想图像】一致，会造成失真。

只要失真能控制在一定范围内，就可以接受。因此设计权重。

### 滤波

滤波是线性方法哈。

#### 带噪声图像的频谱特性

（频谱：圆周对称。F(N-1) 和 F(1) 一样，都是一次谐波分量。F(N-1) 是-1次谐波的分量。）

加噪声后：高频能量增加，低频变化不大。频率增加，信噪比减小。

![image-20211025111804338](.\..\..\typora-user-images\image-20211025111804338.png)

高频部分的增加能量，来源于噪声。减弱高频部分的能量，噪声是不是就会减弱了？

#### 低通滤波器，lowpass filter

G(u,v) = H(u,v) F(u,v)。

H：传递函数，乘在频谱上。

F：输入图像的频域特性。

G：输出图像的频域特性。

卷积：g(x,y) = h(x,y) * f(x,y)。

h：点扩展函数，point spread function，卷积用。

构造低通滤波器：

- 不能草率地把高频全部扔掉，里面还是有信号的。不然就会失真。
- 减小风险：不采用理想低通滤波器（ideal lowpass filter），仅仅【削弱】高频分量。

##### 高斯滤波器，gaussian lowpass filter

![image-20211025114657166](.\..\..\typora-user-images\image-20211025114657166.png)

传递函数（单位响应函数的傅里叶变换，频域直接乘它就好）是高斯函数（正态分布的概率密度函数）。

##### 均值滤波器，averaging filter

![image-20211025114920619](.\..\..\typora-user-images\image-20211025114920619.png)

应用最普遍，性能最差，计算复杂性最小。就是邻域像素的平均。

窗口越大，降噪效果越好。

频谱是Sa / sinc函数。被 反比例函数 幅度调制 的 正弦波。

总体特性：低通滤波器。

然而在细节上，传递函数H有sin的因素，并不随着频率增加单调减小。考虑一个波瓣，低频被完全截止，再往后的高频反而又可以部分通过，这不太合理，因此性能不好。

#### 中值滤波器，median filter

是非线性的“滤波器”！（并不应该叫滤波器）

在当前像素的一个邻域内，把所有像素值的大小进行排序，将排序的中值作为当前像素的新值。

优点：不会使突变的边界变模糊。只是取中值的话，不会出现原不存在的灰度值。

##### 加权中值滤波器，weighted median filter

中值滤波器的问题：降噪能力取决于窗口，把＜窗口面积/2 的 细节+噪声 都滤掉。

把复制的份数作为权重，靠窗口中间的像素复制很多份，然后再一起拿来排序。这样窗口中间的像素副本更多，更有可能被排成中位数，也就更有可能保护图像的细节。

## 图像锐化 & 对比度增强，Image Sharpening & Contrast Enhancement

图像锐化：图像边界处灰度值变化更加陡峭。陡峭的边缘：更多的高频分量。

对比度增强：提升图像细节与周围区域的灰度差。细节的灰度差：更多的高频分量。

拉伸密集灰度范围的灰度映射 / 同态滤波器 / 对整体灰度分布做调整：也能起到对比度增强的效果，但在图像锐化方面没有效果。

### unsharp masking

动机：频谱分解 / 频段分解，把一个信号在频域分解开，对不同频段采用不同方法，加权后合并在一起。是线性方法。

- 用低通+高通滤波器（两个传递函数互补，相加=1），分解成高频+低频两个部分。可以先滤波得到低（高）频分量，然后做差得到高（低）频分量。
- 把高频用常数 α 加权，再跟低频加在一起。即，调整高频部分的比例。
  - 若α＞1：增大高频部分比例，图像锐化，噪声增强。
  - 若α＜1：抑制高频部分，降噪。
- 简化计算：直接用高通滤波器获得高频分量，然后进行加权，然后原信号 加上/减去 加权后的高频分量。

多分辨 unsharp masking：分成多个频段，每个频段乘一个系数。

### laplacian

散度：$\grad\cdot f=\frac{\part f_x}{\part x}+\frac{\part f_y}{\part y}$。

梯度：$\grad f=\left(\begin{array}{}\frac{\part f_x}{\part x}\\\frac{\part f_y}{\part y}\end{array}\right)$。

laplacian：梯度的散度，$\grad\cdot\grad f=\grad^2f=\frac{\part^2 f_x}{\part x^2}+\frac{\part^2 f_y}{\part y^2}$。

laplacian后的DFT：$-(u^2+v^2)F(u,v)$。直接按照定义推。

拉普拉斯过零点：二阶导数穿过横轴的点，边界处灰度变化最剧烈的位置。

物理上，边界代表物体的边缘，应该是阶跃变化的。但由于成像的缘故，边界被模糊成了一个边界区域。如果在区域内选择一个点作为真正的边界，选择拉普拉斯过零点。【最重要的特点】（但是跟课堂内容没关系）

做法：把二阶导数乘一个＜0 的权重，加到原来函数上去。

其实就是一个unsharp masking：

- x → X，x' → jωX，x'' → (jω)²X = -ω²X。
- ▽²f 或 ω²X，是标准的高通滤波器。
- f1 = f - α▽²f，F1 = (1-α(-ω²)) F = (1+α(u²+v²)) F。

反冲：边缘锐化做过头了。物理上是不合理的，属于图像失真；但能提高视觉感受，在这方面是有益的。

### 同态滤波器，homomorphic filter

retinex算法：基于图像成像模型，在频域中处理，消减 乘性或卷积性 噪声，增强对比度，压缩亮度范围。效果很好。

光反射信息的成像模型：$I(x,y)=L(x,y)R(x,y)$​，其中 L 是光源（低频无效信息），R 是反射系数（高频有效信息）。也就是，光源信息+漫反射信息。

光源信息：太阳光直射+空气漫反射。

如果可以想办法，把成像模型中【光源信息】丢掉，就相当于均匀打光了，所有入射光光线一样强。因此使用 对数域的 unsharp masking 增强高频部分。

I → log 变成 logL+logR → unsharp masking → exp → I hat。

技术细节：unsharp masking 的滤波器，要抵消掉 exp 函数的变换（低灰度段压缩高灰度段拉伸）。

## 彩色图像

![image-20211225144338718](.\..\..\typora-user-images\image-20211225144338718.png)

Hue 色调，Saturation 饱和度，Value 值。

![image-20211225144403620](.\..\..\typora-user-images\image-20211225144403620.png)

还有HSL（Hue Saturation Lightness）。

![image-20211225144611976](.\..\..\typora-user-images\image-20211225144611976.png)
