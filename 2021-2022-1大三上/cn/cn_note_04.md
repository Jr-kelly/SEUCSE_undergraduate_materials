# cn 04 network layer: the data plane

## 概述

网络层：将 segment 从 source 端送到 destiny 端，点对点（主机对主机）。

网络层提供的服务，应与通信子网无关，通信子网的数量、类型、拓扑结构对传输层（网络层上层）是透明的。传输层获得的网络地址应采用统一的编号方式，即使跨越多个LAN和WAN。

发送端：把 segment 封装成 datagram，加一个IP头部；接收端：delivers segments to transport layer。

网络层协议存在于每一个主机和路由器。（传输层没有路由器，在端系统上实现）

- 路由器 和 链路层交换机 的根本区别：服务于不同的网络层协议。链路层交换机服务于第二层链路层，路由器服务于第三层网络层。
- 路由选择 和 转发 的主要区别：
  - 转发：通过check分组首部 + 查转发表（forwarding table），将分组 从一个输入链路接口 转移到 适当的输出链路接口，路由本地动作（只涉及单一路由器），发生时间很短，通常用硬件实现。
  - 路由选择：一个网络的所有router 通过路由选择协议交互，确定分组 从源到目的地 所采取的端到端路径。网络范围处理过程，发生时间较长，通常为几秒，因此用软件实现。

network layer 服务模型：转发 forwarding + 路由 routing。

- data plane，数据平面：每个 router 都有一个数据平面，决定 arriving on router 的 datagram 如何从 input port 被 forwarded 到 router output port。
- control plane，控制平面：网络范围的，network-wide logic。确定 datagram 如何被 routed among routers along end-end path from source host to destination host，路由算法确定转发表。
- 最流行的是 internet best effort（尽力而为）模型，什么也不保障（带宽、loss、按序、时延、congestion反馈）。可靠交付服务由端系统实现，网络层提供无连接服务。运行方式灵活，代价低。

### virtual-circuit & datagram network

网络层提供host-to-host的面向连接（virtual-circuit）或无连接（datagram network）服务，而不同时提供连接+无连接服务。

虚电路服务：

- 逻辑连接，与电路交换（电话网络）不同，不是真正的物理连接。分组沿同一条逻辑连接、按照存储转发方式传送。
- 不需要为虚电路分配带宽。
- 不一定完全保证可靠传输，链路中的任一个组成环节都有可能失效，一旦失效就可能导致所有数据丢失。
- 三阶段：虚电路建立，数据传送，虚电路拆除。
- 与transport layer连接的区别：
  - 传输层连接仅涉及两个端系统，别人并不知道，连接参数也是两个人商量确定；
  - 虚电路连接涉及路径上的所有router，即，每个router都完全知道经过它的所有虚电路（知道上下游信息）。
- 转发策略：
  - 基于分组标签（虚电路号），查转发表。
  - 建立新的虚电路时，转发表增加新表项（占用子网的存储空间），终止连接后被删除。
  - 分组结构为：数据+目的地址+源地址+分组标签。根据输入端口和分组标签，确定输出端口和新的分组标签。
  - 为什么不一个虚电路约定一个VC号（虚电路号）：因为很难去约定。逐链路update VC号，貌似越update越短。

数据报服务：

- 每个分组独立选择路由。尽量沿着同一条路径发送，但允许分组选择不同路径，不过可能导致接收数据的失序。
- 转发策略：基于分组目的地址，查转发表，最大前缀匹配。
- 失效节点可能丢失分组，但不至于坏掉整个传送过程。
- 子网不存储状态信息，但是存储转发表。

比较：

- 性能：
  - 虚电路：如果流量稳定，则带宽不浪费，每个数据源的带宽都可保证，适用。
  - 数据报：如果突发流量，性能不受影响，也不会过载，适用。虚电路会过载，丢掉一部分数据。
- 效率：链路传输速率为 B bps，分组长度 P bit，分组开销 H bit（大概是header），虚电路呼叫建立时间 S s，转接点的延迟 D s。
  - 虚电路：T=S+3\[D+(P+H)/B]。
  - 数据报：T=3\[D+(P+H)/B]。
- 应用：
  - 数据报最终被internet采用，因为网络的突发流量很多（email，web）。
  - 虚电路仍有使用：MPLS 多协议标签交换，昂贵的静态设置。

## router工作原理

router一个接口对应一个IP（按理来说是这样，但其实不一定，因为辅助ip，具体不太明白干什么用的）。

### 核心功能

- routing，路由：控制层（control plane），management，software，millisecond。运行各种路由协议（BGP、OSPF、RIP），学习去往不同目的的转发路径（路由表）。
- forwarding，转发：数据层（data plane），hardware，nanosecond。根据路由表，将收到的IP分组转发到正确的下一跳（hop）链路。

### forwarding过程

- 链路层解封装，IP头部校验。（为什么不校验报文信息，只校验头部呢，因为transport layer校验过了）。
- 获取报文目的IP地址。
- 用目的IP地址，基于最长前缀匹配规则，查询转发表。
- 查询失败，丢弃报文。
- 查询成功：
  - 获取转发出接口和下一跳IP地址。
  - IP头部 TTL 字段值减1（担心报文一直在网络里走环路），重新计算IP头部的校验和。
  - 重新进行链路层封装，发送报文。
- forwarding前后的变化：链路层封装更新，IP头部 TTL 减1，IP header 校验和 更新。

### data plane的硬件单元

#### 报文输入的接口卡（输入端口）

- 输入端口功能：
  - 链路层解封装。
  - 查转发表（在输入接口卡执行）。
  - 通过交换结构，将报文排队发往目的接口卡（发送过快将产生拥塞）。
- 流程/结构单元：
  - 线路端接：大概是 physical layer 拆封成 link layer。
  - 数据链路处理：link layer protocol 拆封。
  - 查找 转发 排队：
    - 分布式交换，decentralized switching：使用头部字段中的目的地址，在 输入端口 缓存的 前向转发表查找输出端口。
    - 目标：输入端口的处理速度能够达到线路速度。如果数据到达速度大于forwarding速度，就会排队。
- 转发匹配：最长前缀匹配，硬件实现（三态内容寻址存储器，TCAMs，1s一百多万条）。

#### 交换结构，switching fabrics

- 功能：从输入接口卡发往输出接口卡。
- 交换速率的一些术语：
  - 背板带宽：交换机接口处理器、或接口卡和数据总线间，所能吞吐的最大数据量。
  - 线速：指经过交换机处理的理想状态下最大数据率。端口在满负载的情况下，对帧进行无差错的转发，称为线速转发。
- 三种交换结构：
  - memory，共享内存：类似于磁盘I/O，内存带宽（CPU）限制交换速率。一次只能转发一个分组（每个分组经过两次系统总线）。
  - bus，总线：一根共享的总线，bus contention 总线竞争（不能并行使用总线），总线速度限制交换速率，适合需求不大的情况。
  - crossbar，交叉总线网络（空分结构型）：
    - 纵横式交换机，2n条总线连接n个入口+n个出口。
    - banyan networks（传统的ATM交换机），交叉节点 crossbar 带缓存。（banyan是榕树的意思）
    - advanced design：将长度变化的 IP分组分片成固定长度的信源，通过交叉网络来交互（一种改进）。

#### 报文输出的接口卡（输出端口）

- 功能：
  - 从交换结构接收报文（排队进行后续处理，到达太快将产生拥塞）。
  - 链路层封装。
  - 从输出接口发送报文。

### queuing strategy

输入输出端口都会出现排队，就像车堵在某种交换路口，进这个路口要排队，出去也要排队。（排队时延和丢包源于缓冲区溢出）

调度规则：

- FIFO，priority（抢占式，非抢占式）。
- round robin，各个输入端口轮流进来，各个输出端口轮流出去。
- weighted fair queuing（WFQ，加权公平排队规则），每个端口都有一个份额。比如，A 0.5 B 0.3 C 0.2，那就 A 5个包 B 3个包 C 2个包 这样RR。

队列满后，丢弃规则：

- tail drop（弃尾）：丢掉刚刚来的包，经典的缓冲区满。
- Priority（优先级），Random（随机）。

扩展知识：

- 家用路由器不运行动态路由协议（出口唯一），运行DHCP协议，分配私有IP。轻巧便携，与典型网络路由器差异较大。
- 路由器的端系统表现（但不是端系统）：有些路由器包含完整TCP/IP协议栈，也作为网络端系统进行协议交互（远程网络管理SNMP，远程网络配置SSH）。
- 传统路由器只有3层结构。

## IP协议【重点】

internet协议（网际协议）的两个基本功能：

- 寻址（addressing）：下一跳在哪里。
- 分片（fragmenting）。

以IPv4（使用最广泛的版本）为例，IP datagram format：

![image-20211130082336582](.\..\..\typora-user-images\image-20211130082336582.png)

![image-20211130082741510](.\..\..\typora-user-images\image-20211130082741510.png)

type of service：服务类型，SMTP、FTP、DNS、ICMP等

fragment offset：该 segment 第一个字节在原（需要分片的）数据报中的字节位置，再除8。

options：IPv6已经去掉了这个字段。

TCP 和 IP 都是（最少） 20 byte 头部字段。

### IP 分片与重组【必考 选择 / 计算】

（btw，IPv6不允许在router上对分组分片）

起因：

- 并不是所有的 link layer protocol 都能承载相同长度的网络层分组，链路层的frame能承载的最大数据量叫做 MTU（maximum transmission unit）。
- 因此，可能会出现一个大包（貌似一般是UDP包）超过了下一段链路的MTU，不知道该怎么发过去。

有关数据报长度：

- 链路层：（以太网）物理特性决定了数据帧的长度为 (46+18) ~ (1500+18)，18是数据帧的头尾，因此链路层 MTU=1500。
- 网络层：因为IP包的首部要占用20字节，所以网络层 MTU=1500-20=1480；
- 传输层：
  - UDP：首部占用8字节，所以传输层 MTU=1480-8=1472；
  - TCP：因为TCP包在TCP层已经做了限制，IP层的数据不会超过 MTU, 因此 IP层没有必要分片。
  - 报文总长度 - 20 才是数据长度。segment的有效字节数是 MTU - 20。（被老师上课提问了）
- 应用层：data最大长度=1472。

解决方案：

- 大的IP数据报被router分片成两个或多个较小的数据报（fragment），仅在接收端（end-system）进行重组，IP报头用于识别分段的顺序。
- fragflag 用来表示后面还有没有 fragment，=0 则该 fragment 就是结尾。
- offset 表示 接下来的数据开始于 offset*8 字节。（为什么是8呢，因为length有16位，offset有13位，为了充分利用length（如第一个fragment length拉满，第二个包的offset也恰好拉满）（其实我也不太明白））。
- 总结，分片机制：标识 identifier（同一个id就是一个大包），标志 fragflag，片偏移 offset。

### IP地址分配策略【大概必考】

IP address：32 bit，主机 / 路由器接口的标示。

接口 interface：host/router 和 physical link 的连接，主机/路由器域物理链路的边界，路由器有很多接口，主机有一个或两个接口（比如 wired Ethernet，wireless 802.11）。

要求每个接口都有一个IP地址。

IPv4逻辑地址分类：根据第一个字节。

![image-20211130092851770](.\..\..\typora-user-images\image-20211130092851770.png)

子网部分：高位比特，主机部分：低位比特。或 223.1.3.0/24 格式，24表示子网。IP地址+子网掩码（1 网络位 0 主机位），就可以得到子网地址。

主机位全0：子网地址；主机位全1：广播地址。

同一子网的主机之间可以通信，需要交换设备（交换机、hub），不需要路由器。

- 全0的网络地址：只在系统启动时有效，用于启动时临时通信，又叫主机地址（没听懂）。
- 127.0.0.0 127.0.0.1：环回地址，代表自己，用来ping自己测试TCP/IP通不通（数据包仅下到IP层，用ICMP协议）。
- 全0的主机地址：网络本身的地址；全1的主机地址：定向广播（需要指定主机号）。
- 0.0.0.0：任意地址；
- 255.255.255.255：本地广播，受限广播，无需知道本地网络地址。
- 标识内部网络（内网地址），Internet上router不会转发目标地址在这三个范围内的数据包：
  - A类：10.0.0.0 ～ 10.255.255.255；
  - B类：172.16.0.0 ～ 172.31.255.255；
  - C类：192.168.0.0 ～ 192.168.255.255。
- 指向所有子网的广播：IP地址由 网络地址+子网地址+主机地址 组成时（如B类网络再划分子网），子网地址和主机地址都全置1（随便看看即可）。

地址不够用的解决方案：

- CIDR（classless inter-domain routing，无类域间路由），将 hostid 的一部分作为 netid 的延伸，用 /24 的格式记录 netid 位数。
- 就是灵活配置子网掩码，子网增多、子网里的host减少。
- 一个地址可以对应多个子网，看 netid 位数多少，允许重叠。
- router forwarding 的时候，总是选取子网掩码最长的匹配项。

ppt上有一些地址分配的例题。

怎样得到IP地址：

- 静态设定：申请固定IP地址，手工设定，如路由器、服务器；
- 动态获取：使用DHCP协议或其他动态配置协议。当主机加入IP网络，允许主机从DHCP服务器动态获取IP地址。可以有效利用IP地址，方便移动主机的地址获取。

### DHCP协议

Dynamic Host Configuration Protocol。是应用层协议。

工作过程：

- DHCP 客户 从UDP端口68 以【广播】形式 向服务器发送发现报文（DHCP DISCOVER）；（广播：不知道哪个host是DHCP服务器；UDP：不能TCP，因为一不知道 DHCP server 的IP地址，二自己有没有IP地址。）
- DHCP 服务器【单播或广播】发出提供报文（DHCP OFFER）；
- DHCP 客户从多个 DHCP 服务器中选择一个，并向其以【广播】形式发送 DHCP 请求报文（DHCP REQUEST）；
- 被选择的 DHCP 服务器【单播】发送确认报文（DHCP ACK），包括IP地址、缺省路由器IP地址（第一跳路由器地址，默认网关）、DNS服务器域名+IP地址、网络掩码。

![image-20211207101851883](.\..\..\typora-user-images\image-20211207101851883.png)

MAC地址：用来确认网络设备位置的位址，可以唯一标示一个网卡。在OSI模型中，第三层网络层负责IP地址，第二层数据链路层则负责MAC位址。

### NAT，网络地址翻译

network address translation。

动机：IP地址不够用，本地网络仅使用一个IP地址与外网相连（代表所有设备）。可以改变设备地址。可以改变ISP，而与内部无关。内部设备的地址对外界不可见。

私网IP（内网IP）→ 公网IP（internet IP）。

实现：将内网IP+端口号 映射到 router的一个端口号。router有非常多端口号，因此没问题。

### IPv6

128位地址！

固定的40字节首部，不允许分片。checksum，options等字段去掉了。增加了流标签、优先级

有一个新版ICMPv6。

与IPv4共存：隧道，tunneling。把IPv6的报文封装到IPv4的payload（data，有效载荷）里。

## SDN（不做要求）

留给读研再学……

（202304 考古，我读研才不学这个 😪









